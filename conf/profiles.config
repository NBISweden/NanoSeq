/*
----------------------------------------------------------------------------------------
Execution profiles
----------------------------------------------------------------------------------------
*/

profiles {

	standard {
		process.executor = 'local'
		process {
			withLabel: process_single {
				cpus = 1
				memory = 2.GB
			}
			withLabel: process_low {
				cpus = 2
				memory = 4.GB
			}
			withLabel: process_medium {
				cpus = 4
				memory = 8.GB
			}
			withLabel: process_high {
				cpus = 16
				memory = 15.GB
			}
		}
	}

	dardelSlurm {
		containerOptions = "-B /cfs/klemming/"
		executor {
			name = 'slurm'
			account = 'PROJECT_NUMBER'
			jobName = { "${task.name.tokenize(':')[-1].replaceAll(/[^a-zA-Z0-9]/, '_')}_${task.hash.take(10)}".replaceAll(/_+/, '_') }
			queueSize = 1000
		}
		process {
			errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'terminate' }
			maxRetries = 2
			withLabel: process_single {
				queue = 'shared'
				cpus = 1
				memory = { 20.GB * task.attempt }
				time = { 5.h * task.attempt }
			}
			withLabel: process_low {
				queue = 'shared'
				cpus = { 48 * task.attempt }
				memory = { 39.GB * task.attempt }
				time = { 5.h * task.attempt }
			}
			withLabel: process_medium {
				queue = 'main'
				clusterOptions = '--nodes=1'
				cpus = 64
				memory = 230.GB
				time = { 12.h * task.attempt }
			}
			withLabel: process_high {
				queue = 'memory'
				clusterOptions = '--nodes=1'
				cpus = 64
				memory = 460.GB
				time = { 12.h * task.attempt }
			}
		}
	}

	// Original Sanger lsf_singularity profile, unchanged (note partial functional redundancy with "conf/containers.config").

	lsf_singularity {
		singularity.enabled = true
		singularity.autoMounts = true
		singularity.cacheDir = "$PWD"
		singularity.envWhitelist = "REF_PATH,REF_CACHE"
		process.executor = 'lsf'
		process.queue = 'normal'
		executor.perJobMemLimit = true
		executor.queueSize = 200
		process.cache = 'lenient' //necesary for lustre
		process.errorStrategy = 'retry' //relaunch jobs upon failure
		process.maxRetries = 2
		process.beforeScript = 'module load singularity/3.9.0'
		env.REF_PATH = "/path/to/cram_cache/%2s/%2s/%s" //required for CRAM
	}

}
